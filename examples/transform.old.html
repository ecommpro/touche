<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="description" content="Touché JS Demos.">
  <meta name="keywords" content="touche, js, javascript, touch, mouse, pointer, events, gestures">
  <meta name="author" content="Manel R. Doménech">
  <link rel="stylesheet" href="css/style.css" />

  <style>
#viewport {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  touch-action: none;
}

#box {
  position: absolute;
  background: radial-gradient(#fff, #5ba7ff);
  width: 50%;
  height: 50%;
  top: 0;
  left: 0;
}

#center {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #000;
  margin-left: -5px;
  margin-top: -5px;
}


  </style>
</head>
<body>

  <div id="viewport">
    <div id="box">
    </div>

    <div id="center"></div>
  </div>

<script src="/dist/touche.js"></script>

<script>
var
  pan = touche.gestures.pan(),
  pinch = touche.gestures.pinch(),
  rotate = touche.gestures.rotate()
;

var el = document.getElementById('viewport');
var box = document.getElementById('box');
var c = document.getElementById('center');


var
  scale = 1,
  rotation = 0,
  tx = 0,
  ty = 0,
  cx = 0,
  cy = 0
;

var bounds = box.getBoundingClientRect();

var adjustx = 0, adjusty = 0;

var lastadjustx, lastadjusty;

function refresh() {
  var vx = cx - bounds.left;
  var vy = cy - bounds.top;

  var transforms = [
    'rotate(' + rotation +'deg)',
    'scale(' + scale + ')',    
    'translate(' + (tx + adjustx) + 'px, ' + (ty + adjusty) + 'px)',
  ];

  var transform = transforms.join(" ");
  var origin = (vx) + 'px ' + (vy) + 'px';
  
  box.style.transform = transform;
  box.style["transform-origin"] = origin;

  c.style.left = cx + 'px';
  c.style.top = cy + 'px';
}

var virtualInput = touche.input.virtual();
var pointer = virtualInput.pointer(1)

touche(el)
  .addInput(virtualInput)
  .addGesture(pan)
  .addGesture(pinch)
  .addGesture(rotate)
  .on('touche.input', function(input) {
    input.stopEvent();
  })
  .on('panmove', function(result, input, session, calculator) {
    tx = input.deltaX;
    ty = input.deltaY;
  })  
  .on('rotatemove', function(result, input, session, calculator) {
    rotation = input.rotation;
  })
  .on('pinchmove', function(result, input, session, calculator) {
    scale = input.scale;
  })
  .on('touche.recentered', function(result, input) {
    var v = result.newCenterDelta2;
    console.log(v);
    //var v = result.centerMoved;    
    //adjustx = v.x;
    //adjusty = v.y;
  })
  .on('touche.post', function(input) {
    cx = input.centerX;
    cy = input.centerY;
    refresh();    
  })
  ;

  pointer.start();
 
</script>


</body>
</html>